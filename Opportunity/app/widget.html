<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <script type="text/javascript" src="https://extension.zoho.com/widgetsdk/extension.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <script src="https://live.zwidgets.com/js-sdk/1.1/ZohoEmbededAppSDK.min.js"></script>

  <style>
    .container {
      margin-top: 50px;
    }
  </style>
</head>

<body>

  <div class="container">
    <label for="callPurpose" class="form-label">Call Purpose:</label>
    <select id="callPurpose" class="form-select">
      <option value="None" selected>None</option>
      <option value="Cold Call">Cold Call</option>
      <option value="Introductory call">Introductory call</option>
      <option value="Opportunity">Opportunity</option>
    </select>

    <div class="table-responsive mt-4" id="tableContainer">
      <table class="table table-bordered table-striped">
        <thead class="table-dark" id="tableHeaders">
          <tr><th>Deal Name</th><th>Closing Date</th><th>Account Name</th><th>Stage</th><th>Action</th></tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <button id="addRecordBtn" class="btn btn-primary mt-3" onclick="showAddRecordForm()">Add Record</button>

    <!-- Add Record Form Modal -->
    <div class="modal" tabindex="-1" role="dialog" id="addRecordForm" style="display: none;">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Create Deal</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="recordForm">
              <div class="mb-3">
                <label for="dealName" class="form-label">Deal Name</label>
                <input type="text" class="form-control" id="dealName" required>
              </div>
              <div class="mb-3">
                <label for="closingDate" class="form-label">Closing Date (DD/MM/YYYY)</label>
                <input type="text" class="form-control" id="closingDate" required>
              </div>
              <div class="mb-3">
                <label for="newRecordStage" class="form-label">Stage</label>
                <select id="newRecordStage" class="form-select">
                  <option value="Qualification">Qualification</option>
                  <option value="Needs Analysis">Needs Analysis</option>
                  <option value="Value Proposition">Value Proposition</option>
                  <option value="Negotiation">Negotiation</option>
                </select>
              </div>
              <!-- Add new form fields -->
              <div class="mb-3">
                <label for="orderDeliverDate" class="form-label">Order Deliver Date (DD/MM/YYYY)</label>
                <input type="text" class="form-control" id="orderDeliverDate" required>
              </div>
              <div class="mb-3">
                <label for="orderCloseDate" class="form-label">Order Close Date (DD/MM/YYYY)</label>
                <input type="text" class="form-control" id="orderCloseDate" required>
              </div>
              <button type="submit" class="btn btn-primary">Add Record</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Declare the showAddRecordForm function in the global scope
    function showAddRecordForm() {
      $('#addRecordForm').modal('show');
    }

    $(document).ready(function () {
      let accId;
      let selectedValue;
      let accName;

      ZOHO.embeddedApp.on("PageLoad", function (initial_data) {
        console.log("Initial data", initial_data);
        accId = initial_data.EntityId[0];
        console.log("Account Id", accId);
      });

      $('#callPurpose').change(function () {
        selectedValue = $(this).val();
        console.log('Selected Call Purpose:', selectedValue);
        if (selectedValue == "Opportunity") {
          getRecord(selectedValue);
        } else {
          hideTable();
        }
      });

      // getting values of opportunity record
      function getRecord() {
        ZOHO.CRM.API.getRelatedRecords({ Entity: "Accounts", RecordID: accId, RelatedList: "Deals", page: 1, per_page: 200 })
          .then(function (data) {
            console.log('Parent Data', data);
            ZOHO.CRM.API.getRecord({
              Entity: "Deals", RecordID: "591312000000681001"
            })
              .then(function (data) {
                console.log(data)
              })

            const status = data.status;
            if (status === 204) {
              showNoDealsAlert();
            }
            else {
              const dealsData = data.data;
              console.log(dealsData.length);

              if (dealsData.length > 0) {
                generateTable(dealsData);
              }
              else {
                showAddRecordForm();
              }
            }
          });
      }

      // generate dynamic table
      function generateTable(dealsData) {
        const tableContainer = $('#tableContainer');
        const tableHeaders = $('#tableHeaders');
        const tableBody = $('#tableBody');
        tableBody.empty(); // Clear previous table body

        if (dealsData.length > 0) {
          tableContainer.show(); // Show the table container if there are records
          if (selectedValue == "Opportunity") {
            tableHeaders.show(); // Show the table headers only for Opportunity
          } else {
            tableHeaders.hide();
          }
          dealsData.forEach(element => {
            console.log(element);
            const stageOptions = getStageOptions(element.Stage);
            const row = $(`<tr data-id="${element.id}"><td>${element.Deal_Name}</td><td>${element.Closing_Date}</td><td>${element.Account_Name.name}</td><td><select class="form-select">${stageOptions}</select></td><td><button class="btn btn-primary updateBtn">Update</button></td></tr>`);
            tableBody.append(row);
          });

          // Add click event for table rows
          $('tr').on('click', function () {
            const id = $(this).data('id');
            const dealName = $(this).find('td:eq(0)').text();
            const closingDate = $(this).find('td:eq(1)').text();
            const accountName = $(this).find('td:eq(2)').text();
            const selectedStage = $(this).find('.form-select').val();

            console.log("ID:", id);
            console.log("Deal Name:", dealName);
            console.log("Closing Date:", closingDate);
            console.log("Account Name:", accountName);
            console.log("Selected Stage:", selectedStage);
          });

          // Add click event for update button
          $('.updateBtn').on('click', function (event) {
            event.stopPropagation(); // Prevent row click event from firing
            const row = $(this).closest('tr');
            const id = row.data('id');
            const dealName = row.find('td:eq(0)').text();
            const closingDate = row.find('td:eq(1)').text();
            const accountName = row.find('td:eq(2)').text();
            const selectedStage = row.find('.form-select').val();

            console.log("ID:", id);
            console.log("Deal Name:", dealName);
            console.log("Closing Date:", closingDate);
            console.log("Account Name:", accountName);
            console.log("Selected Stage:", selectedStage);
            updateRecord(id, selectedStage);
          });
        } else {
          hideTable(); // Hide the table container and headers if there are no records
        }
      }

      // show alert when no deals are found
      function showNoDealsAlert() {
        swal({
          title: "No Deals Found!",
          text: "There are no deals associated with this account. Do you want to create a new deal?",
          icon: "info",
          buttons: ["Cancel", "OK"],
        }).then((value) => {
          if (value) {
            showAddRecordForm();
          }
        });
      }

      // hide the table container and reset content
      function hideTable() {
        $('#tableContainer').hide();
        $('#tableHeaders').hide();
        $('#tableBody').empty();
      }

      // get stage dropdown options with selected value
      function getStageOptions(selectedStage) {
        const stages = ["Qualification", "Needs Analysis", "Value Proposition", "Negotiation"];
        return stages.map(stage => `<option value="${stage}" ${stage === selectedStage ? 'selected' : ''}>${stage}</option>`).join('');
      }

      // update record with the selected stage
      function updateRecord(id, selectedStage) {
        var config = {
          Entity: "Deals",
          APIData: {
            "id": id,
            "Stage": selectedStage
          },
          Trigger: []
        }
        ZOHO.CRM.API.updateRecord(config)
          .then(function (data) {
            console.log(data)
          })
      }

      // clear page content
      function clearPageContent() {
        $('#tableContainer').hide();
        $('#tableHeaders').hide();
        $('#tableBody').empty();
      }

      // Add form submission logic
      $('#recordForm').submit(function (event) {
        event.preventDefault();

        const dealName = $('#dealName').val();
        const closingDate = $('#closingDate').val();
        const newRecordStage = $('#newRecordStage').val();
        const orderDeliverDate = $('#orderDeliverDate').val();
        const orderCloseDate = $('#orderCloseDate').val();

        // Log the form data to the console
        console.log("Deal Name:", dealName);
        console.log("Closing Date:", closingDate);
        console.log("Stage:", newRecordStage);
        console.log("Order Deliver Date:", orderDeliverDate);
        console.log("Order Close Date:", orderCloseDate);

        // Create a data object with the desired format
        const data = {
          'Deal_Name': dealName,
          'Closing_Date': closingDate,
          'Stage': newRecordStage,
          'Order_Delivery_Date': orderDeliverDate,
          'Order_Closer_Date': orderCloseDate,
          // Add other fields as needed
        };

        console.log(data);

        // Convert the data object to Zoho CRM API format
        const recordData = {
          "data": data,
        };

        // API call to insert the new record
        ZOHO.CRM.API.insertRecord({ Entity: "Deals", APIData: recordData }).then(function (response) {
          console.log(response);

          // You can handle success or error responses here

          // Clear the form fields after submission
          $('#dealName').val('');
          $('#closingDate').val('');
          $('#newRecordStage').val('');
          $('#orderDeliverDate').val('');
          $('#orderCloseDate').val('');

          // Hide the form again
          $('#addRecordForm').modal('hide');
        });
      });

      ZOHO.embeddedApp.init();
    });
  </script>
</body>

</html>
