<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://live.zwidgets.com/js-sdk/1.1/ZohoEmbededAppSDK.min.js"></script>
  </head>
  <body>
    <script>
      $(document).ready(function () {
        let parentData;
        let dealId;

        ZOHO.embeddedApp.on("PageLoad", function (initial_data) {
          console.log("Initial data", initial_data);
          dealId = initial_data.EntityId[0];
          console.log(dealId);
          ZOHO.CRM.API.getRecord({
            Entity: "Deals", RecordID: dealId
          })
          .then(function(data){
              console.log(data)
              parentData = data.data;
              sendData(parentData);
          })
        });

        function sendData(parentData) {
          parentData.forEach(element => {
            let formattedData = {
              "data": {
                "Amount": element.Amount,
                "Type": element.Type || "Not Mentioned",
                "Probability (%)": element.Probability,
                "Expected Revenue": element.Expected_Revenue,
                "Lead Source": element.Lead_Source,
                "Sales Cycle Duration": element.Sales_Cycle_Duration
              }
            };
            
            console.log("Formatted Data", formattedData);
            const jsonData = JSON.stringify({ formattedData });

            // Make a POST request using Axios
            axios.post('https://api.catalyst.zoho.in/quickml/v1/project/6149000000005071/endpoints/predict', jsonData, {
              headers: {
                'Content-Type' : 'application/json',
                'X-QUICKML-ENDPOINT-KEY': '16db4cf44203fc66cc7403b05ca87f6f8957d1c94f657387291399be61e81b7b26b5e96cdaec35f8be763703e920b0cb',
                'Authorization': 'Zoho-oauthtoken 1000.3e537615effaac5173a42f6393e603b1.d2a13c44e7a05c1631f59fcce7506543',
                'CATALYST-ORG': 60027588282,
                'Environment': 'Development'
              },
              withCredentials: true
            })
            .then(response => {
              console.log('Prediction API Response:', response.data);
              // Handle the response as needed
            })
            .catch(error => {
              console.error('Error making prediction API request:', error.message);
              console.log('Error details:', error);
              // Handle the error as needed
            });
            // Function to get current Indian Time
            function getIndianTime() {
              const options = {
                timeZone: 'Asia/Kolkata',
                hour12: false, // Set to true if you want 12-hour format
              };
              const indianTime = new Date().toLocaleString('en-US', options);
              return indianTime;
            }

            // Example usage
            const currentIndianTime = getIndianTime();
            console.log('Current Indian Time:', currentIndianTime);

          });
        }

        ZOHO.embeddedApp.init();
      });
    </script>
  </body>
</html>
